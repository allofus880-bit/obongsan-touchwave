<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TouchWave v5.5.1 — Quantum Light Tunnel (Compatibility Fix)</title>

<style>
  html, body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: "Noto Sans KR", sans-serif;
    color: #d8f7ff;
  }

  #fileInput {
    position: fixed;
    top: 20px; left: 20px;
    z-index: 20;
    padding: 8px 14px;
    color: #d8f7ff;
    background: rgba(255,255,255,0.08);
    border: 1px solid #5af;
    border-radius: 8px;
  }
</style>
</head>

<body>

<input id="fileInput" type="file" accept="audio/*" multiple />

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>

<script>
/* ======================================================
   Global Variables
====================================================== */
let scene, camera, renderer, stars, tunnel, audio, audioCtx, analyser;
let dataArray;

/* ======================================================
   Initialize WebGL Scene
====================================================== */
function initScene() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 2000);
  camera.position.z = 35;

  renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  /* Force Render First Frame (Fix: black screen) */
  renderer.render(scene, camera);

  /* Galaxy Stars */
  const geo = new THREE.BufferGeometry();
  const count = 15000;
  const pos = new Float32Array(count * 3);

  for (let i = 0; i < count * 3; i++) {
    pos[i] = (Math.random() - 0.5) * 500;
  }
  geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));

  const mat = new THREE.PointsMaterial({
    size: 1.2,
    color: 0xffffff,
    transparent: true,
    opacity: 0.85
  });

  stars = new THREE.Points(geo, mat);
  scene.add(stars);

  /* Light Tunnel */
  const tunnelGeo = new THREE.TorusGeometry(14, 4.5, 32, 200);
  const tunnelMat = new THREE.MeshBasicMaterial({
    color: 0x6688ff,
    wireframe: true,
    transparent: true,
    opacity: 0.35
  });
  tunnel = new THREE.Mesh(tunnelGeo, tunnelMat);
  scene.add(tunnel);

  /* WebGL Context Restore Handler */
  renderer.domElement.addEventListener("webglcontextlost", (e) => {
    alert("WebGL context lost — 재시작합니다.");
    e.preventDefault();
  });

  renderer.domElement.addEventListener("webglcontextrestored", () => {
    initScene();
  });
}

/* ======================================================
   Audio + Analyzer Setup
====================================================== */
function initAudio(file) {
  audio = new Audio(URL.createObjectURL(file));

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();

  const src = audioCtx.createMediaElementSource(audio);
  src.connect(analyser);
  analyser.connect(audioCtx.destination);

  analyser.fftSize = 1024;
  let bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);

  audio.play();
}

/* ======================================================
   Animation Loop
====================================================== */
function animate(t) {
  requestAnimationFrame(animate);

  let tt = t * 0.001;

  stars.rotation.y += 0.0003;
  stars.rotation.x += 0.00015;

  tunnel.rotation.z += 0.003;
  tunnel.rotation.x = Math.sin(tt * 0.3) * 0.25;

  if (analyser) {
    analyser.getByteFrequencyData(dataArray);
    let bass = dataArray[1] / 255;

    tunnel.scale.set(1 + bass * 0.5, 1 + bass * 0.5, 1 + bass * 0.5);

    let col = new THREE.Color(
      0.5 + Math.sin(tt * 1.3) * 0.5,
      0.5 + Math.sin(tt * 1.3 + 2) * 0.5,
      0.5 + Math.sin(tt * 1.3 + 4) * 0.5
    );
    tunnel.material.color = col;
  }

  renderer.render(scene, camera);
}
animate();

/* ======================================================
   File Selection (Start)
====================================================== */
document.getElementById("fileInput").addEventListener("change", (e) => {
  let file = e.target.files[0];
  if (!file) return;

  document.getElementById("fileInput").style.display = "none";

  initAudio(file);
});

/* ======================================================
   Resize
====================================================== */
addEventListener("resize", () => {
  if (!renderer) return;
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>


