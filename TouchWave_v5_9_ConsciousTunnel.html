<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TouchWave v5.9 — Conscious Tunnel Edition</title>

<style>
  html, body {
    margin: 0;
    overflow: hidden;
    background: #000;
  }

  #fileInput {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 20;
    padding: 8px 14px;
    border-radius: 10px;
    background: rgba(255,255,255,0.1);
    border: 1px solid #66aaff;
    color: #fff;
    cursor: pointer;
  }
</style>
</head>

<body>
<input type="file" id="fileInput" accept="audio/*" multiple>
<canvas id="tunnel"></canvas>

<script>
/* ===============================
   Canvas 기본 설정
================================ */
const canvas = document.getElementById("tunnel");
const ctx = canvas.getContext("2d");
resize();
window.addEventListener("resize", resize);

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}

/* ===============================
   오디오: 여러 파일 자동 순환
================================ */
let audioCtx, analyser, dataArray;
let audio = null;
let playlist = [];
let index = 0;

// 음악 재생 함수
function play(idx) {
  if (!playlist.length) return;
  index = idx % playlist.length;
  const file = playlist[index];

  if (!audioCtx) audioCtx = new AudioContext();
  if (audio) audio.pause();

  audio = new Audio();
  audio.src = URL.createObjectURL(file);
  audio.load();
  audio.play();

  const source = audioCtx.createMediaElementSource(audio);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  dataArray = new Uint8Array(analyser.frequencyBinCount);

  source.connect(analyser);
  analyser.connect(audioCtx.destination);

  audio.onended = () => {
    index++;
    play(index);
  };

  // 방송용: 파일선택창 숨김
  document.getElementById("fileInput").style.display = "none";
}

document.getElementById("fileInput").addEventListener("change", e => {
  playlist = [...e.target.files];
  index = 0;
  play(0);
});

/* ===============================
   Conscious Tunnel (LMH 파동)
================================ */
let t = 0;

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  let w = canvas.width;
  let h = canvas.height;
  let cx = w / 2;
  let cy = h / 2;

  // 기본 터널 레이어
  const layers = 42;
  const base = Math.min(w, h) * 0.42;

  // LMH 의식 흐름 색상
  let hueBase = (t * 0.25) % 360;  // 心(심): 감정 순환

  // 오디오 반응
  let bass = 0, mid = 0, high = 0;
  if (analyser) {
    analyser.getByteFrequencyData(dataArray);
    bass = dataArray[1] / 255;    // 命(명): 생명력 반응
    mid  = dataArray[40] / 255;   // 心(심): 감정 떨림
    high = dataArray[120] / 255;  // 理(이): 고음 정보
  }

  // "의식의 숨결" 그 자체
  let breath = (Math.sin(t * 0.02) * 0.5 + 0.5);   // 느린 호흡
  let breathScale = 1 + breath * 0.25;             // 25% 크기 변화

  for (let i = 0; i < layers; i++) {
    const depth = i / layers;

    // 레이어 깊이 변화 + 호흡
    let radius = base * (1 - depth) * breathScale;

    // 음악 반응
    radius *= (1 + bass * depth * 0.5);

    // LMH 색 (심 → 명 → 이 흐름)
    let hue = (hueBase + depth * 220 + high * 60) % 360;
    ctx.strokeStyle = `hsla(${hue}, 80%, ${60 - depth*40}%, ${1-depth})`;

    // 라인 두께
    ctx.lineWidth = 3 * (1-depth);

    ctx.beginPath();
    ctx.arc(cx, cy, radius, 0, Math.PI * 2);
    ctx.stroke();
  }

  // 코어 (의식의 핵)
  let coreR = 20 + mid * 10;
  let coreHue = (hueBase + 180) % 360;
  ctx.fillStyle = `hsla(${coreHue}, 90%, 70%, 0.9)`;
  ctx.beginPath();
  ctx.arc(cx, cy, coreR, 0, Math.PI*2);
  ctx.fill();

  t++;
  requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
